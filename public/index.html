
<!DOCTYPE HTML>
<html>
 <head>
  <meta charset="utf-8">
  <title>Таблица</title>
  <script src="/socket.io/socket.io.js"></script>
 </head>
 <body>
 </body>
 <script>
    let socket = io();
    socket.on('data', (data) => {
        updateTable(data)
    })

    function setColorCell(cell, value) {
        if (!cell || isNaN(value)) {
            return console.error('setColor not found cell', cell , 'or value', value)
        }

        let backColor = 'rgb(255, 255, 255)'
        let textColor = '#000000'
        if (value >= -1 && value < 0) {
            backColor = 'rgba(255, 140, 0, ' + Math.abs(value) + ')'
        }
        if (value > 0 && value < 1 ) {
            backColor = 'rgba(0, 0, 0, ' + Math.abs(value) + ')'
            textColor = '#ffffff'
        }
        cell.style['background-color'] = backColor
        cell.style['color'] = textColor
    }
    function updateTable(data) {
        let tbl = document.getElementById('table')
        for (let i = 0; i < data.length; i++) {
            let id = document.getElementById(data[i].id)

            // console.log('')
            // уже есть запись в таблице
            if (id) {
                function changeLineValue() {
                    for (let key in data[i]) {
                        let tr = document.getElementById(id)
                        let entity = ''
                        if (key == 'id') {
                            entity = 'Entity'
                        }

                        let td = document.getElementById(data[i].id + '_' + key)
                        td.innerHTML = entity + data[i][key]
                        setColorCell(td, data[i][key])
                    }
                }
                changeLineValue()
            } else {
                function createLine() {
                    let tr = document.createElement('tr')
                    tbl.insertRow(-1)
                    tr.id = data[i].id

                    for (let key in data[i]) {
                        // console.log('data[i]', key, data[i][key])

                        let td = document.createElement('td')
                        td.id = data[i].id + '_' + key
                        let entity = ''
                        if (key == 'id') {
                            entity = 'Entity'
                        }
                        td.appendChild(document.createTextNode(entity + data[i][key]))
                        setColorCell(td, data[i][key])
                        tr.appendChild(td)
                    }
                    tbl.prepend(tr)
                }
                createLine()
            }
        }
    }

    function clickSelectList(i) {
        console.log('clickSelectList', i);
    }

    function tableCreate() {
        let body = document.getElementsByTagName('body')[0]
        let tbl = document.createElement('table')
        tbl.id = 'table'
        tbl.style['border-collapse'] = 'collapse'
        tbl.setAttribute('border', '1')
        let tbdy = document.createElement('tbody')
        tbl.appendChild(tbdy);
        body.appendChild(tbl)
        
        function addTotalLine() {
            let tr = document.createElement('tr')
            tr.id = 'total'
            let td = document.createElement('td')
            td.appendChild(document.createTextNode('ИТОГО:'))
            tr.appendChild(td)

            for (let i = 0; i < 20; i++) {
                let td = document.createElement('td')
                var array = ["sum", "min","max","avg"];

                var selectList = document.createElement("select");
                selectList.onchange = function(data) {
                    console.log(data.target.selectedIndex)
                    clickSelectList(i+1)
                }
                selectList.id = 'total' + (i + 1)
                td.appendChild(selectList)

                for (var j = 0; j < array.length; j++) {
                    var option = document.createElement("option");
                    option.value = array[j];
                    option.text = array[j];
                    selectList.appendChild(option);
                }
                tr.appendChild(td)
            }
            tbl.appendChild(tr)
        }
        addTotalLine()
    }
    tableCreate()
  </script>
</html>